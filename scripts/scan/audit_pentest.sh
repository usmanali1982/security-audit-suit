#!/bin/bash
set -euo pipefail

DATE=$(date +%Y-%m-%d_%H-%M)
REPORT_DIR="/opt/security-audit/reports/$DATE-pentest"
mkdir -p "$REPORT_DIR"

echo "================================================="
echo "     FULL INTERNAL PENTEST (AGGRESSIVE MODE)"
echo "================================================="
echo "Report Directory: $REPORT_DIR"
echo "Run Time: $(date)"
echo


#############################################
# 1. Full Nmap Exploitation Scan
#############################################
echo "ðŸ”¥ Nmap FULL EXPLOIT scan..."
nmap -sV -O -T4 --script=vuln,brute,exploit \
  localhost > "$REPORT_DIR/nmap-full.txt"


#############################################
# 2. OWASP ZAP Full Active Attack
#############################################
echo "ðŸ”¥ Running OWASP ZAP ACTIVE MODE..."
docker run --rm \
  -v "$REPORT_DIR:/zap/wrk" \
  zaproxy/zap-stable zap-full-scan.py \
  -t http://localhost \
  -r zap-full-report.html


#############################################
# 3. Nikto Deep Scan
#############################################
echo "ðŸ”¥ Running Nikto deep enumeration..."
nikto -h http://localhost -Tuning 1 2 3 4 5 6 7 8 9 \
  > "$REPORT_DIR/nikto-deep.txt"


#############################################
# 4. WordPress Deep Vulnerability Scan
#############################################
if command -v wpscan &>/dev/null; then
  echo "ðŸ”¥ Running WPScan deep audit..."
  wpscan --url http://localhost --enumerate ap,at,cb,dbe \
    --random-user-agent \
    > "$REPORT_DIR/wpscan.txt" || true
fi


#############################################
# 5. Laravel, Golang & React Deep Audit
#############################################
echo "ðŸ”¥ Deep framework audit..."

LARAVEL_FILE=/var/www/html/.env
if [ -f "$LARAVEL_FILE" ]; then
  echo "â†’ Found Laravel .env â€” scanning for secrets..." | tee "$REPORT_DIR/laravel-secret-audit.txt"
  grep -E "(KEY|PASSWORD|MAIL|AWS)" "$LARAVEL_FILE" >> "$REPORT_DIR/laravel-secret-audit.txt"
fi

echo "â†’ Checking exposed React build files..."
find /var/www -name ".map" > "$REPORT_DIR/react-source-maps.txt" || true

echo "â†’ Checking Golang debug endpoints..."
curl -s http://localhost/debug/pprof/ > "$REPORT_DIR/golang-pprof.txt" || true


#############################################
# 6. TLS / SSL FULL Scan
#############################################
echo "ðŸ”¥ Running testssl FULL scan..."
testssl --fast --parallel --warnings-batch https://localhost \
  > "$REPORT_DIR/tls-full.txt"


#############################################
# 7. System Abuse Simulation
#############################################
echo "ðŸ”¥ Simulating host brute-force abuse..."
hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://localhost \
  > "$REPORT_DIR/ssh-bruteforce-sim.txt" || true


#############################################
# 8. Summary
#############################################
echo "================================================="
echo "    âœ” FULL INTERNAL PENTEST COMPLETED"
echo "    Reports saved in: $REPORT_DIR"
echo "================================================="


